<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CGPA Calculator</title>
    <!-- Tailwind CSS for modern styling and responsiveness -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // --- Core Application Logic (Pure JavaScript) ---

        // Global state for the application session
        let courses = [];
        let isAppReady = false;
        let editingTimestamp = null; // Stores the timestamp of the course currently being edited

        // Constants
        const TOTAL_PROGRAM_CREDITS = 162; // Total credits required for the degree (assuming 8 semesters)

        // Modal elements declared globally but assigned later in initializeApp
        let modal, modalTitle, modalMessage, modalActions;

        // Grade Point Mapping (S-E = 10-5, F=0)
        const gradeMap = {
            'S': 10, 'A': 9, 'B': 8, 'C': 7, 'D': 6, 'E': 5, 'F': 0
        };
        
        // Grades that count as a "Pass" for GPA credit earning purposes.
        const passingGrades = ['S', 'A', 'B', 'C', 'D', 'E']; 
        // Grades that count as a "Pass" for Non-GPA credit earning purposes.
        const nonGpaPassingGrades = ['P']; // Only 'P' (Pass) counts for Non-GPA credits

        /**
         * Initializes the application.
         */
        function initializeApp() {
            // Assign modal DOM elements here to ensure they exist.
            modal = document.getElementById('custom-modal');
            modalTitle = document.getElementById('modal-title');
            modalMessage = document.getElementById('modal-message');
            modalActions = document.getElementById('modal-actions');
            
            // Safety check for critical UI elements
            if (!modal || !modalTitle || !modalMessage || !modalActions) {
                 console.error("Fatal Error: Could not find one or more modal elements in the DOM. Check IDs.");
                 document.getElementById('app-status').textContent = 'Error: UI not fully loaded.';
                 isAppReady = false;
                 return;
            }

            document.getElementById('app-status').textContent = 'Ready (Data is NOT saved, session only)';
            isAppReady = true;

            // Attach listener for the Non-GPA checkbox to toggle grade inputs
            document.getElementById('non-gpa-input').onchange = toggleGradeInputs;
            // Initial toggle state
            toggleGradeInputs();

            renderUI(courses); // Render the initial empty state
        }
        
        /**
         * Toggles the visibility of the standard grade selector and the Pass/Fail selector.
         */
        function toggleGradeInputs() {
            const isNonGpaChecked = document.getElementById('non-gpa-input').checked;
            document.getElementById('grade-input').classList.toggle('hidden', isNonGpaChecked);
            document.getElementById('non-gpa-grade-input').classList.toggle('hidden', !isNonGpaChecked);

            // Clear the hidden input's value to prevent accidental submission of two grades
            if (isNonGpaChecked) {
                 document.getElementById('grade-input').value = ''; 
            } else {
                 document.getElementById('non-gpa-grade-input').value = 'P'; // Default P for P/F mode
            }
        }
        
        // --- CGPA/GPA Calculation Logic ---
        
        /**
         * Calculates GPA and CGPA from the list of courses.
         * @param {Array<Object>} courses - The list of course objects.
         */
        function calculateGrades(courses) {
            const semesterData = {};
            let cumulativeCredits = 0; // Credits contributing to CGPA calculation denominator (Includes failed GPA courses)
            let cumulativeGradePoints = 0;
            let totalCreditsEarned = 0; // All credits actually earned (Passed courses only)
            let totalCreditsAttempted = 0; // All credits attempted (for semester breakdown)

            courses.forEach(course => {
                
                // Semester Initialization (Happens regardless of GPA status)
                if (!semesterData[course.semester]) {
                    semesterData[course.semester] = { 
                        totalCreditsAttempted: 0, 
                        totalCreditsEarned: 0,
                        totalGradePoints: 0, 
                        totalCredits: 0, // Credits used for SGPA calculation (GPA courses only)
                        courses: [] 
                    };
                }

                // Determine if the course passed based on its type
                const isPassed = course.isNonGpa 
                    ? nonGpaPassingGrades.includes(course.grade) 
                    : passingGrades.includes(course.grade);      

                // Mark the credit as attempted (for semester/cumulative attempted total)
                totalCreditsAttempted += course.credits;
                semesterData[course.semester].totalCreditsAttempted += course.credits;


                // --- Non-GPA Course Logic ---
                if (course.isNonGpa) {
                    // Add to semester list for display, but without contribution to totals
                    semesterData[course.semester].courses.push({ 
                        ...course, 
                        gradePoint: 0, 
                        totalGradePoints: 0
                    });

                    // CREDITS EARNED LOGIC: Non-GPA credits count towards Total Credits Earned ONLY if passed.
                    if (isPassed) {
                        totalCreditsEarned += course.credits;
                        semesterData[course.semester].totalCreditsEarned += course.credits;
                    }
                    // Skip all GPA/CGPA totals
                    return; 
                }

                // --- Standard GPA Course Logic (Grade F handled here) ---
                
                // Standard GPA Calculation
                const gp = gradeMap[course.grade] || 0;
                const tgp = course.credits * gp; // Total Grade Points
                
                // 1. Cumulative Calculation for CGPA
                // F grade (0 GP) contributes to the CGPA denominator (cumulativeCredits) and numerator (0 GP).
                cumulativeCredits += course.credits;
                cumulativeGradePoints += tgp;

                // 2. Total Credits Earned (Standard GPA courses only count credits if passed)
                if (isPassed) {
                    totalCreditsEarned += course.credits;
                    semesterData[course.semester].totalCreditsEarned += course.credits;
                }

                // 3. Semester Calculation (Only includes GPA-contributing credits for SGPA)
                semesterData[course.semester].totalCredits += course.credits; 
                semesterData[course.semester].totalGradePoints += tgp;
                semesterData[course.semester].courses.push({ ...course, gradePoint: gp, totalGradePoints: tgp });
            });

            // Calculate SGPA for each semester
            Object.keys(semesterData).forEach(sem => {
                const data = semesterData[sem];
                // SGPA only uses credits contributing to GPA (i.e., graded courses - totalCredits)
                data.sgpa = data.totalCredits > 0 ? (data.totalGradePoints / data.totalCredits).toFixed(2) : '0.00';
            });

            // Calculate CGPA
            const cgpa = cumulativeCredits > 0 ? (cumulativeGradePoints / cumulativeCredits).toFixed(2) : '0.00';

            // Calculate Credit Left (based on Total Credits Earned)
            const creditsLeft = Math.max(0, TOTAL_PROGRAM_CREDITS - totalCreditsEarned);

            return { 
                semesterData, 
                cgpa, 
                totalCreditsEarned, 
                creditsLeft
            };
        }

        /**
         * Renders the courses and GPA summary to the DOM from the local array.
         * @param {Array<Object>} courses - The local list of course objects.
         */
        function renderUI(courses) {
            const { semesterData, cgpa, totalCreditsEarned, creditsLeft } = calculateGrades(courses);
            
            // 1. Render CGPA Summary
            document.getElementById('cgpa-value').textContent = cgpa;
            document.getElementById('total-credits-value').textContent = totalCreditsEarned.toFixed(1);
            document.getElementById('credits-left-value').textContent = creditsLeft.toFixed(1);
            
            // 2. Update the Save button text
            document.getElementById('add-course-button').textContent = editingTimestamp !== null ? 'Save Changes' : 'Add Course & Calculate';


            // 3. Render Credit Breakdown inside the header
            const breakdownHtml = renderCreditBreakdown(semesterData);
            document.getElementById('credits-breakdown-container').innerHTML = breakdownHtml;


            // 4. Render Semester-wise Course Breakdown
            const courseBreakdownContainer = document.getElementById('breakdown-container');
            courseBreakdownContainer.innerHTML = '';

            const sortedSemesters = Object.keys(semesterData).sort((a, b) => parseInt(a) - parseInt(b));

            if (courses.length === 0) {
                 courseBreakdownContainer.innerHTML = '<p class="text-gray-500 text-center py-8">Start adding courses to see your grades here.</p>';
                 return;
            }

            sortedSemesters.forEach(sem => {
                const semData = semesterData[sem];
                const semCourses = semData.courses.sort((a, b) => a.timestamp - b.timestamp);

                const semElement = document.createElement('div');
                semElement.className = 'mb-6 p-4 bg-white/70 backdrop-blur-sm rounded-xl shadow-lg border border-gray-100';
                
                let courseRows = '';
                semCourses.forEach(course => {
                    // Use the timestamp as a unique ID for deletion/editing
                    const id = course.timestamp; 

                    // Determine pass status based on type and grade
                    const isPassed = course.isNonGpa 
                        ? nonGpaPassingGrades.includes(course.grade)
                        : passingGrades.includes(course.grade); 
                    
                    // DISPLAY LOGIC: Handle Non-GPA vs GPA (Failed) courses
                    let gradeDisplay = course.isNonGpa ? course.grade : `${course.grade} (${course.gradePoint})`;
                    let totalGPDisplay = course.totalGradePoints.toFixed(1);
                    let creditDisplay = course.credits.toFixed(1);
                    let rowClass = 'hover:bg-indigo-50'; // Default for graded passes

                    if (course.isNonGpa) {
                        // NON-GPA LOGIC
                        const gradeText = course.grade === 'P' ? 'PASS' : 'FAIL';
                        gradeDisplay = `<span class="font-bold ${isPassed ? 'text-green-600' : 'text-red-600'}">${gradeText}</span>`;
                        totalGPDisplay = '—';
                        rowClass = isPassed ? 'bg-green-50/50 hover:bg-green-100/50' : 'bg-red-50/50 hover:bg-red-100/50';
                        
                        if (!isPassed) {
                            creditDisplay = `<span class="line-through text-red-500" title="Credits not earned due to failure">${creditDisplay}</span>`;
                        } else {
                            creditDisplay = `<span class="text-green-600 font-semibold" title="Credits earned but excluded from GPA">${creditDisplay}</span>`;
                        }
                    } else if (course.grade === 'F') {
                        // GPA FAIL LOGIC
                        gradeDisplay = `<span class="font-bold text-red-700">F (0 GP)</span>`;
                        totalGPDisplay = '0.0';
                        creditDisplay = `<span class="line-through text-red-500" title="Credits failed. Contributed to CGPA calculation but NOT earned.">${creditDisplay}</span>`;
                        rowClass = 'bg-red-100/70 hover:bg-red-200/70';
                    }
                    
                    courseRows += `
                        <tr class="border-b border-gray-100 transition-colors ${rowClass}">
                            <td class="px-4 py-2 font-medium">${course.name}</td>
                            <td class="px-4 py-2 text-center">${creditDisplay}</td>
                            <td class="px-4 py-2 text-center">${gradeDisplay}</td>
                            <td class="px-4 py-2 text-center">${totalGPDisplay}</td>
                            <td class="px-4 py-2 text-center flex justify-center space-x-2 items-center">
                                <button onclick="editCourse('${id}')" title="Edit Course" class="flex items-center text-indigo-500 hover:text-indigo-700 transition-colors p-1 rounded-full hover:bg-indigo-100">
                                    <!-- Pencil Icon -->
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-1">
                                        <path d="M5.433 13.917V12.9H4.55v1.017h.883ZM16.633 6.083l-1.017 1.017L12.55 4.083l1.017-1.017a1.442 1.442 0 0 1 2.041 0l1.017 1.017a1.442 1.442 0 0 1 0 2.041ZM3.7 15.55v-3.033L10.967 5.25l3.033 3.033-7.267 7.267H3.7ZM15.55 6.083l-1.017 1.017L12.55 4.083l1.017-1.017a1.442 1.442 0 0 1 2.041 0l1.017 1.017a1.442 1.442 0 0 1 0 2.041ZM3.7 15.55v-3.033L10.967 5.25l3.033 3.033-7.267 7.267H3.7Z" clip-rule="evenodd" fill-rule="evenodd"/>
                                    </svg>
                                    <span class="text-xs font-semibold">Edit</span>
                                </button>
                                <button onclick="deleteCourse('${id}')" title="Delete Course" class="flex items-center text-red-500 hover:text-red-700 transition-colors p-1 rounded-full hover:bg-red-100 ml-2">
                                    <!-- Trash Icon -->
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-1">
                                        <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.5H2.75a.75.75 0 0 0 0 1.5h.5v9.25c0 1.2.98 2.25 2.25 2.25h9.5c1.27 0 2.25-1.05 2.25-2.25V5.75h.5a.75.75 0 0 0 0-1.5H14v-.5A2.75 2.75 0 0 0 11.25 1h-2.5ZM10 12a.75.75 0 0 1-.75-.75V8.5a.75.75 0 0 1 1.5 0v2.75a.75.75 0 0 1-.75.75Zm.75-6.75a1.25 1.25 0 1 1-2.5 0 1.25 1.25 0 0 1 2.5 0ZM8.5 8.5a.75.75 0 0 0-1.5 0v2.75a.75.75 0 0 0 1.5 0v-2.75ZM13.25 8.5a.75.75 0 0 0-1.5 0v2.75a.75.75 0 0 0 1.5 0v-2.75Z" clip-rule="evenodd" />
                                    </svg>
                                    <span class="text-xs font-semibold">Delete</span>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                semElement.innerHTML = `
                    <h3 class="text-xl font-bold text-gray-800 mb-2 border-b pb-2">
                        Semester ${sem}
                        <span class="ml-4 text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full text-lg shadow-sm">
                            SGPA: ${semData.sgpa}
                        </span>
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr class="bg-gray-50 text-gray-600 uppercase text-sm leading-normal">
                                    <th class="py-3 px-4 text-left">Course Name</th>
                                    <th class="py-3 px-4 text-center">Credits</th>
                                    <th class="py-3 px-4 text-center">Grade (GP)</th>
                                    <th class="py-3 px-4 text-center">Total GP</th>
                                    <th class="py-3 px-4 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-600 text-sm font-light">
                                ${courseRows}
                            </tbody>
                        </table>
                    </div>
                `;
                courseBreakdownContainer.appendChild(semElement);
            });
        }

        /**
         * Renders the detailed credit breakdown summary.
         * @param {Object} semesterData - The calculated data grouped by semester.
         */
        function renderCreditBreakdown(semesterData) {
            let breakdownHtml = `
                <div id="credits-breakdown-container-content" class="mt-6 p-4 bg-gray-50 rounded-xl shadow-inner border border-gray-200">
                    <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2 text-teal-600">
                            <path fill-rule="evenodd" d="M1 11.5a.5.5 0 0 1 .5-.5h17a.5.5 0 0 1 0 1h-17a.5.5 0 0 1-.5-.5Zm0-4a.5.5 0 0 1 .5-.5h17a.5.5 0 0 1 0 1h-17a.5.5 0 0 1-.5-.5Zm0-4a.5.5 0 0 1 .5-.5h17a.5.5 0 0 1 0 1h-17a.5.5 0 0 1-.5-.5Z" clip-rule="evenodd" />
                        </svg>
                        Semester Credit Breakdown
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr class="bg-teal-100/70 text-teal-800 uppercase text-xs leading-normal">
                                    <th class="py-2 px-3 text-left">Semester</th>
                                    <th class="py-2 px-3 text-center">Credits Attempted</th>
                                    <th class="py-2 px-3 text-center">Credits Earned</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-700 text-sm font-light divide-y divide-gray-100">
            `;

            const sortedSemesters = Object.keys(semesterData).sort((a, b) => parseInt(a) - parseInt(b));

            sortedSemesters.forEach(sem => {
                const data = semesterData[sem];

                breakdownHtml += `
                    <tr class="hover:bg-teal-50/50 transition-colors">
                        <td class="py-2 px-3 font-semibold">Sem ${sem}</td>
                        <td class="py-2 px-3 text-center">${data.totalCreditsAttempted.toFixed(1)}</td>
                        <td class="py-2 px-3 text-center font-bold text-green-700">${data.totalCreditsEarned.toFixed(1)}</td>
                    </tr>
                `;
            });

            breakdownHtml += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            return breakdownHtml;
        }


        /**
         * Enters edit mode by populating the form with the selected course data.
         * @param {string} editTimestamp - The timestamp of the course to edit.
         */
        window.editCourse = function(editTimestamp) {
            const timestampToEdit = parseInt(editTimestamp);
            const courseToEdit = courses.find(c => c.timestamp === timestampToEdit);
            
            if (!courseToEdit) {
                showModal("Error", "Course not found for editing.");
                return;
            }

            // Set state
            editingTimestamp = timestampToEdit;

            // Populate Form
            document.getElementById('semester-input').value = courseToEdit.semester;
            document.getElementById('course-name-input').value = courseToEdit.name;
            document.getElementById('credits-input').value = courseToEdit.credits.toFixed(1);
            document.getElementById('non-gpa-input').checked = courseToEdit.isNonGpa || false;

            // Set the correct grade input based on type
            toggleGradeInputs(); // Update selector visibility first
            if (courseToEdit.isNonGpa) {
                document.getElementById('non-gpa-grade-input').value = courseToEdit.grade;
            } else {
                document.getElementById('grade-input').value = courseToEdit.grade;
            }

            // Update button text and show cancel button
            document.getElementById('add-course-button').textContent = 'Save Changes';
            document.getElementById('cancel-edit-container').classList.remove('hidden');

            // Scroll to the form
            document.getElementById('course-entry-form').scrollIntoView({ behavior: 'smooth' });
        }

        /**
         * Exits edit mode and clears the form.
         */
        window.cancelEdit = function() {
            editingTimestamp = null;
            document.getElementById('add-course-button').textContent = 'Add Course & Calculate';
            document.getElementById('cancel-edit-container').classList.add('hidden');
            
            // Clear form (resetting to default values)
            document.getElementById('course-name-input').value = '';
            document.getElementById('credits-input').value = '3.0';
            document.getElementById('grade-input').value = 'A'; // Default graded
            document.getElementById('non-gpa-grade-input').value = 'P'; // Default non-graded
            document.getElementById('semester-input').value = '1';
            document.getElementById('non-gpa-input').checked = false; 

            toggleGradeInputs(); // Reset visibility

            // Re-render to clear any highlight/state logic in the UI (optional but clean)
            renderUI(courses); 
        }

        /**
         * Adds a new course or updates an existing one based on editingTimestamp state.
         * This replaces the old addCourse function.
         */
        window.saveCourse = function() {
            if (!isAppReady) return;
            
            const semester = document.getElementById('semester-input').value;
            const courseName = document.getElementById('course-name-input').value.trim();
            const credits = parseFloat(document.getElementById('credits-input').value);
            const isNonGpa = document.getElementById('non-gpa-input').checked; 

            let grade;
            if (isNonGpa) {
                // Use P/F selector for non-GPA courses
                grade = document.getElementById('non-gpa-grade-input').value;
            } else {
                // Use standard selector for graded courses
                grade = document.getElementById('grade-input').value;
            }


            // Validation (remains the same)
            if (!courseName || isNaN(credits) || credits <= 0 || !grade) {
                showModal("Validation Error", "Please ensure all fields are filled correctly. Credits must be a positive number.");
                return;
            }
            
            // Validate graded courses against the grade map
            if (!isNonGpa && !(grade in gradeMap)) {
                 showModal("Validation Error", `Grade '${grade}' is not a valid grade. Valid grades are S, A, B, C, D, E, F.`);
                 return;
            }
            
            const newCourseData = {
                semester: parseInt(semester),
                name: courseName,
                credits: credits,
                grade: grade, // Either S-F or P/F
                isNonGpa: isNonGpa,
            };

            if (editingTimestamp !== null) {
                // --- UPDATE MODE ---
                const index = courses.findIndex(c => c.timestamp === editingTimestamp);

                // DUPLICATE CHECK FOR EDIT MODE: Check against all *other* course names
                const isDuplicate = courses.some(c => 
                    c.name.toLowerCase() === courseName.toLowerCase() && c.timestamp !== editingTimestamp
                );

                if (isDuplicate) {
                    showModal("Error", `A course named '${courseName}' already exists. Please use a unique name.`);
                    return;
                }

                if (index !== -1) {
                    courses[index] = { ...courses[index], ...newCourseData };
                    showModal("Success", `Course '${courseName}' updated successfully.`);
                } else {
                    showModal("Error", "Could not find course to update.");
                }
                cancelEdit(); 
            } else {
                // --- ADD MODE ---
                // DUPLICATE CHECK FOR ADD MODE
                const isDuplicate = courses.some(c => c.name.toLowerCase() === courseName.toLowerCase());

                if (isDuplicate) {
                    showModal("Error", `A course named '${courseName}' already exists. Please edit the existing entry or use a unique name.`);
                    return; 
                }

                const newCourse = {
                    ...newCourseData,
                    timestamp: Date.now() 
                };
                courses.push(newCourse);
                showModal("Success", `Course '${courseName}' added successfully.`);
                
                // Clear input fields after successful addition
                document.getElementById('course-name-input').value = '';
                document.getElementById('credits-input').value = '3.0';
                document.getElementById('non-gpa-input').checked = false;
                toggleGradeInputs(); // Reset visibility
            }
            
            // Re-render UI after any action
            renderUI(courses);
        }

        /**
         * Deletes a course from the local array and updates the UI.
         * @param {string} deleteTimestamp - The timestamp of the course to delete.
         */
        window.deleteCourse = function(deleteTimestamp) {
            if (!isAppReady) return;
            
            // Confirmation is handled by the custom modal logic
            confirmAction.show('Confirm Deletion', 'Are you sure you want to delete this course?', () => {
                // Convert timestamp back to number for comparison
                const timestampToDelete = parseInt(deleteTimestamp);

                // Filter the global courses array, keeping only those that don't match the timestamp
                const initialLength = courses.length;
                courses = courses.filter(course => course.timestamp !== timestampToDelete);

                if (courses.length < initialLength) {
                    renderUI(courses);
                } else {
                    showModal("Error", "Could not find the course to delete.");
                }
            });
        }
        
        // --- PDF Generation Logic ---
        
        window.printReport = function() {
            const studentName = document.getElementById('student-name-input').value.trim();
            const totalCreditsEarned = document.getElementById('total-credits-value').textContent;
            const cgpa = document.getElementById('cgpa-value').textContent;
            
            if (!studentName) {
                showModal("Name Required", "Please enter your name before generating the PDF report.");
                return;
            }
            if (courses.length === 0) {
                 showModal("No Data", "Please add at least one course before generating the PDF report.");
                 return;
            }

            const { semesterData } = calculateGrades(courses);
            
            // Generate the Semester Breakdown HTML
            let breakdownHtml = '';
            const sortedSemesters = Object.keys(semesterData).sort((a, b) => parseInt(a) - parseInt(b));

            sortedSemesters.forEach(sem => {
                const semData = semesterData[sem];
                const semCourses = semData.courses.sort((a, b) => a.timestamp - b.timestamp);
                
                let courseRows = '';
                semCourses.forEach(course => {
                    const isPassed = course.isNonGpa 
                        ? nonGpaPassingGrades.includes(course.grade)
                        : passingGrades.includes(course.grade); 
                    
                    let gradeDisplay = course.isNonGpa ? (course.grade === 'P' ? 'PASS (Non-GPA)' : 'FAIL (Non-GPA)') : `${course.grade} (${course.gradePoint})`;
                    let creditStatus = isPassed ? 'Earned' : 'Not Earned';
                    let totalGP = course.isNonGpa ? '—' : course.totalGradePoints.toFixed(1);

                    courseRows += `
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;">${course.name}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${course.credits.toFixed(1)}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${gradeDisplay}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${totalGP}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center; color: ${isPassed ? '#10B981' : '#EF4444'};">${creditStatus}</td>
                        </tr>
                    `;
                });

                breakdownHtml += `
                    <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 8px;">
                        <h3 style="font-size: 1.25rem; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">
                            Semester ${sem} &mdash; SGPA: ${semData.sgpa}
                        </h3>
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="background-color: #f3f4f6;">
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Course Name</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Credits</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Grade</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Total GP</th>
                                    <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Credit Status</th>
                                </tr>
                            </thead>
                            <tbody>${courseRows}</tbody>
                        </table>
                    </div>
                `;
            });
            
            // Construct the final HTML for the print window
            const printContent = `
                <html>
                <head>
                    <title>CGPA Report - ${studentName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        h1 { color: #1e40af; border-bottom: 2px solid #1e40af; padding-bottom: 5px; margin-bottom: 20px; }
                        .summary { display: flex; justify-content: space-between; margin-bottom: 30px; }
                        .summary-box { flex: 1; margin-right: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
                        .summary-box:last-child { margin-right: 0; }
                        .summary-value { font-size: 1.8rem; font-weight: bold; margin-top: 5px; }
                        .credit-status { font-size: 0.8rem; }
                        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                        th, td { border: 1px solid #ddd; padding: 8px; }
                        th { background-color: #e5e7eb; text-align: left; }
                        .sgpa { font-weight: bold; color: #1e40af; }
                        /* Print-specific styles */
                        @media print {
                            body { margin: 0; }
                            .summary { display: block; }
                            .summary-box { margin-bottom: 10px; margin-right: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <h1>CGPA Academic Performance Report</h1>
                    <p style="font-size: 1.1rem; margin-bottom: 25px;"><strong>Student Name:</strong> ${studentName}</p>
                    
                    <div class="summary" style="display: flex; gap: 20px;">
                        <div class="summary-box">
                            <div style="font-weight: 600;">Overall CGPA</div>
                            <div class="summary-value" style="color: #1e40af;">${cgpa}</div>
                        </div>
                        <div class="summary-box">
                            <div style="font-weight: 600;">Total Credits Earned</div>
                            <div class="summary-value">${totalCreditsEarned}</div>
                        </div>
                        <div class="summary-box">
                            <div style="font-weight: 600;">Credits Left (Target: ${TOTAL_PROGRAM_CREDITS})</div>
                            <div class="summary-value">${calculateGrades(courses).creditsLeft.toFixed(1)}</div>
                        </div>
                    </div>

                    <h2>Detailed Semester Breakdown</h2>
                    ${breakdownHtml}

                    <p class="credit-status no-print" style="margin-top: 30px; font-size: 0.8rem; color: #777;">
                        Report generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}.
                    </p>
                </body>
                </html>
            `;

            // Open in new window, write content, and trigger print
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        };


        // --- Custom Modal and Confirmation Logic (No alert/confirm) ---
        
        function hideModal() {
            modal.classList.add('hidden');
        }

        window.showModal = function(title, message, confirmCallback = null) {
            if (!modal) return; // Prevent error if initializeApp failed
            
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalActions.innerHTML = '';

            const closeButton = document.createElement('button');
            closeButton.className = 'px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition-colors shadow-md';
            closeButton.textContent = 'Close';
            closeButton.onclick = hideModal;
            modalActions.appendChild(closeButton);

            if (confirmCallback) {
                const confirmButton = document.createElement('button');
                confirmButton.className = 'px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition-colors shadow-md ml-3';
                confirmButton.textContent = 'Confirm';
                confirmButton.onclick = () => {
                    hideModal();
                    confirmCallback();
                };
                modalActions.appendChild(confirmButton);
            }

            modal.classList.remove('hidden');
        }

        // A simplified wrapper for window.confirm replacement
        const confirmAction = {
            show: (title, message, callback) => {
                showModal(title, message, callback);
                return true;
            }
        };


        // --- Initialization ---
        window.onload = initializeApp;
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
            min-height: 100vh;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #e5e7eb;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="main-app-container" class="max-w-6xl mx-auto">
        <!-- Header and Summary -->
        <header class="mb-8 p-6 bg-white rounded-2xl shadow-xl border-t-4 border-indigo-600">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h1 class="text-3xl font-extrabold text-gray-900 mb-1 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8 mr-3 text-indigo-600">
                            <path d="M11.7 2.875A.75.75 0 0 1 12 3.75v16.5a.75.75 0 0 1-1.294.577l-2.486-2.302A.75.75 0 0 1 8 18h-1.5A2.25 2.25 0 0 1 4.25 15.75V8.25A2.25 2.25 0 0 1 6.5 6H8a.75.75 0 0 1 .706-.577l2.486-2.302Z" />
                            <path fill-rule="evenodd" d="M15.5 6.75a2.25 2.25 0 0 0-2.25 2.25v4.5c0 1.24.965 2.25 2.25 2.25s2.25-1.01 2.25-2.25V9a2.25 2.25 0 0 0-2.25-2.25Zm.16 3.864a.75.75 0 0 0-1.272-.731 28.537 28.537 0 0 0-1.07 3.991.75.75 0 0 0 .809.827c.452-.07.86-.29 1.144-.645a.75.75 0 0 0-.256-1.168Z" clip-rule="evenodd" />
                            <path d="M15.5 3A.75.75 0 0 0 15 3.75v1.252A4.25 4.25 0 0 0 13.25 6H8a.75.75 0 0 0-.75.75v10.5c0 .414.336.75.75.75h4.94a4.25 4.25 0 0 0 3.72-1.928V15.75a2.25 2.25 0 0 0 2.25-2.25V9a2.25 2.25 0 0 0-2.25-2.25V3.75A.75.75 0 0 0 15.5 3Z" />
                        </svg>
                        Simple CGPA Calculator
                    </h1>
                    <p class="text-sm text-gray-500 mt-1">This is a session-based calculator. All data is lost when you close or refresh the page.</p>
                </div>
                
                <div class="flex flex-col space-y-2 w-full max-w-xs ml-4">
                    <input type="text" id="student-name-input" placeholder="Enter Your Name for Report" 
                        class="px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm"
                    />
                    <button onclick="printReport()" class="flex items-center justify-center px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2">
                            <path fill-rule="evenodd" d="M5 2.75A2.75 2.75 0 0 1 7.75 0h4.5A2.75 2.75 0 0 1 15 2.75v2.5a.75.75 0 0 1-1.5 0V2.75a1.25 1.25 0 0 0-1.25-1.25h-4.5A1.25 1.25 0 0 0 6.25 2.75v2.5a.75.75 0 0 1-1.5 0v-2.5ZM5.5 8.75a.75.75 0 0 1 1.5 0v2.5a.75.75 0 0 1-1.5 0v-2.5Zm8.5 0a.75.75 0 0 1 1.5 0v2.5a.75.75 0 0 1-1.5 0v-2.5Z" clip-rule="evenodd" />
                            <path fill-rule="evenodd" d="M12.75 1.5a.75.75 0 0 1 .75.75v2.5a.75.75 0 0 1-1.5 0V2.25a.75.75 0 0 1 .75-.75Zm-6.5 0a.75.75 0 0 1 .75.75v2.5a.75.75 0 0 1-1.5 0V2.25a.75.75 0 0 1 .75-.75Z" clip-rule="evenodd" />
                            <path fill-rule="evenodd" d="M3.5 6.75c0-.414.336-.75.75-.75h11.5a.75.75 0 0 1 .75.75v8a.75.75 0 0 1-.75.75H4.25a.75.75 0 0 1-.75-.75v-8Z" clip-rule="evenodd" />
                        </svg>
                        Print CGPA Report
                    </button>
                </div>
            </div>
            
            <!-- Main Numeric Summary Boxes -->
            <div class="flex flex-wrap gap-4">
                <div class="p-4 bg-indigo-50 border border-indigo-200 rounded-lg shadow-inner flex-1 min-w-[150px]">
                    <p class="text-sm font-medium text-indigo-700">Overall CGPA</p>
                    <p id="cgpa-value" class="text-3xl font-bold text-indigo-600 mt-1">--</p>
                </div>
                <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg shadow-inner flex-1 min-w-[150px]">
                    <p class="text-sm font-medium text-gray-700">Total Credits Earned</p>
                    <p id="total-credits-value" class="text-3xl font-bold text-gray-600 mt-1">--</p>
                </div>
                <!-- Credits Left Box - Text fixed -->
                <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg shadow-inner flex-1 min-w-[150px]">
                    <p class="text-sm font-medium text-gray-700">Credits Left</p>
                    <p id="credits-left-value" class="text-3xl font-bold text-gray-600 mt-1">--</p>
                </div>
            </div>

            <!-- Integrated Credit Breakdown Summary -->
            <div id="credits-breakdown-container">
                <!-- Content generated by renderCreditBreakdown -->
            </div>
            
            <p id="app-status" class="text-xs mt-3 text-green-600 font-medium">Initializing...</p>
        </header>

        <!-- Course Entry Form -->
        <div id="course-entry-form" class="mb-8 p-6 bg-white rounded-2xl shadow-xl border-l-4 border-blue-500">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Add/Edit Course</h2>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div class="md:col-span-2">
                    <label for="course-name-input" class="block text-sm font-medium text-gray-700">Course Name</label>
                    <input type="text" id="course-name-input" placeholder="e.g., Data Structures" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                <div>
                    <label for="semester-input" class="block text-sm font-medium text-gray-700">Semester</label>
                    <select id="semester-input" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border bg-white">
                        <option value="1">1st Semester</option>
                        <option value="2">2nd Semester</option>
                        <option value="3">3rd Semester</option>
                        <option value="4">4th Semester</option>
                        <option value="5">5th Semester</option>
                        <option value="6">6th Semester</option>
                        <option value="7">7th Semester</option>
                        <option value="8">8th Semester</option>
                    </select>
                </div>
                <div>
                    <label for="credits-input" class="block text-sm font-medium text-gray-700">Credits</label>
                    <input type="number" id="credits-input" value="3.0" step="0.5" min="0.5" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                <div>
                    <label for="grade-input" class="block text-sm font-medium text-gray-700">Grade</label>
                    <!-- Grade Selectors Container -->
                    <div id="grade-selectors">
                        <!-- 1. Standard Graded Selector (Visible by default) -->
                        <select id="grade-input" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border bg-white">
                            <option value="S">S (10 GP)</option>
                            <option value="A" selected>A (9 GP)</option>
                            <option value="B">B (8 GP)</option>
                            <option value="C">C (7 GP)</option>
                            <option value="D">D (6 GP)</option>
                            <option value="E">E (5 GP)</option>
                            <option value="F">F (0 GP)</option>
                        </select>
                        <!-- 2. Non-GPA Pass/Fail Selector (Hidden by default) -->
                        <select id="non-gpa-grade-input" class="mt-1 hidden w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border bg-white">
                            <option value="P" selected>P (Pass)</option>
                            <option value="F">F (Fail)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Checkbox to exclude from GPA -->
            <div class="mt-4">
                <div class="flex items-center">
                    <input id="non-gpa-input" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <label for="non-gpa-input" class="ml-2 block text-sm font-medium text-gray-700 select-none">
                        Exclude from GPA/CGPA (Non-Credit/Audit)
                    </label>
                </div>
            </div>

            <div class="mt-6 flex space-x-3">
                <button id="add-course-button" onclick="saveCourse()" class="w-full md:w-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Add Course & Calculate
                </button>
                <div id="cancel-edit-container" class="hidden">
                    <button onclick="cancelEdit()" class="px-6 py-3 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                        Cancel Edit
                    </button>
                </div>
            </div>
        </div>

        <!-- Course Breakdown -->
        <div class="p-6 bg-white rounded-2xl shadow-xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Semester Course Details</h2>
            <div id="breakdown-container">
                <p class="text-gray-500 text-center py-8">Your courses will appear here in real-time.</p>
            </div>
        </div>
    </div>

    <!-- Custom Modal Structure -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform transition-transform duration-300 scale-100">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-3">Modal Title</h3>
            <p id="modal-message" class="text-gray-600 mb-6">Modal Message</p>
            <div id="modal-actions" class="flex justify-end space-x-3">
                <!-- Buttons will be injected here by JavaScript -->
            </div>
        </div>
    </div>
</body>
</html>